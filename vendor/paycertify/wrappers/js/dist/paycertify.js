"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var s=t[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,r,s){return r&&e(t.prototype,r),s&&e(t,s),t}}();if(void 0===PayCertify)var PayCertify={};PayCertify.Checkout=function(){function e(t){_classCallCheck(this,e),this.API_ENDPOINT="https://api.paycertify.com/api/v1/merchant/kount",this.API_KEY=t.apiKey,this.REQUIRED=["name","email","phone","address","city","state","country","zip","amount"],this.failMessage=t.failMessage||"We were not able to process this transaction at this time.",this.rules=t.rejectWhen||{recommendation:["decline"],rulesTriggered:1,maxScore:50},this.response={},this.errors={},this.$form=document.querySelector("[data-paycertify]").form,this.watchFormSubmit()}return _createClass(e,[{key:"watchFormSubmit",value:function(){var e=this,t=function(t){t.preventDefault(),e.validate(),e.validated()?e._submitData(function(t){t.success?e.$form.submit():e._displayErrors()}):e._displayErrors()};this.formListener=this.$form.addEventListener("submit",t)}},{key:"validate",value:function(){var e;for(var t in this.REQUIRED)(e=this.inputFor(this.REQUIRED[t]))&&""==e.value&&this._addError(this.REQUIRED[t],"Required field is empty.")}},{key:"validated",value:function(){return 0==Object.keys(this.errors).length}},{key:"inputFor",value:function(e){var t='[data-paycertify="'+e+'"]',r=document.querySelector(t);if(r)return r;this.errors[e]="Have you defined this selector? "+t}},{key:"data",value:function(){return{name:this.inputFor("name").value,email:this.inputFor("email").value,phone:this.inputFor("phone").value,address:this.inputFor("address").value,city:this.inputFor("city").value,state:this.inputFor("state").value,country:this.inputFor("country").value,zip:this.inputFor("zip").value,amount:this.inputFor("amount").value,session_id:this.inputFor("session_id").value}}},{key:"_addError",value:function(e,t){this.errors[e]=t}},{key:"_displayErrors",value:function(){var e=new CustomEvent("paycertifyCheckoutFailure",{detail:{response:this.response,errors:this.errors}});window.dispatchEvent(e),this.errors=[]}},{key:"_submitData",value:function(e){var t=this,r={};r.x=function(){if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;for(var e,t=["MSXML2.XmlHttp.6.0","MSXML2.XmlHttp.5.0","MSXML2.XmlHttp.4.0","MSXML2.XmlHttp.3.0","MSXML2.XmlHttp.2.0","Microsoft.XmlHttp"],r=0;r<t.length;r++)try{e=new ActiveXObject(t[r]);break}catch(e){}return e},r.send=function(e,s,i,a){var n=r.x();n.open(i,e,!0),n.onreadystatechange=function(){4==n.readyState&&s(n.responseText)},"POST"==i&&(n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.setRequestHeader("PAYCERTIFYKEY",t.API_KEY)),n.send(a)},r.post=function(e,t,s){var i=[];for(var a in t)i.push(encodeURIComponent(a)+"="+encodeURIComponent(t[a]));r.send(e,s,"POST",i.join("&"))},r.post(this.API_ENDPOINT,this.data(),function(r){t.response=JSON.parse(r),e({success:t._rulesPassed()})})}},{key:"_rulesPassed",value:function(){return"and"==this.rules.mode.toLowerCase()?this._recommendationPassed()&&this._maxRulesTriggeredPassed()&&this._maxScorePassed():"or"==this.rules.mode.toLowerCase()?this._recommendationPassed()||this._maxRulesTriggeredPassed()||this._maxScorePassed():(this.errors.mode="Invalid mode provided. Mode sent was: ",this.rules.mode,!1)}},{key:"_recommendationPassed",value:function(){return"A"==this.response.k_auto||("D"==this.response.k_auto&&this.rules.recommendation.indexOf("decline")>-1?(this.errors.recommendation="This transaction was declined.",!1):"R"==this.response.k_auto&&this.rules.recommendation.indexOf("review")>-1?(this.errors.recommendation="This transaction was flagged to be reviewed.",!1):"E"!=this.response.k_auto||(this.errors.recommendation="This transaction was flagged as escalate (second round of reviews).",!1))}},{key:"_maxRulesTriggeredPassed",value:function(){var e=this.rules.maxRulesTriggered>this.response.k_rules_triggered;return e||(this.errors.maxRulesTriggered="This transaction triggered too many rules: "+this.response.k_rules_triggered.toString()),e}},{key:"_maxScorePassed",value:function(){var e=this.rules.maxScore>parseInt(this.response.k_score);return e||(this.errors.maxScore="This transaction scored too high: "+this.response.k_score),e}}]),e}();